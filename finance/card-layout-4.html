<!DOCTYPE html>
<html lang="en" class="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pulse ‚Äî Top 3 Momentum Setups (Mock)</title>

<!-- Tailwind CDN + enable class-based dark mode -->
<script>
  window.tailwind = {
    config: {
      darkMode: 'class'
    }
  }
</script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
  .card-shadow{ box-shadow:0 10px 30px rgba(0,0,0,.35) }
  .feedback-popup { position: absolute; bottom: -2.5rem; left: 0; right: 0; display: none; }
</style>
</head>

<body class="min-h-screen w-full bg-white text-slate-900 dark:bg-[#0b0f14] dark:text-slate-100 p-6 transition-colors">
  <div class="max-w-6xl mx-auto">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold tracking-tight">Pulse ‚Äî Top 3 Momentum Setups</h1>
        <p class="text-slate-500 dark:text-slate-400 text-sm">Stage: Warm ‚Ä¢ Side: Selective Bull ‚Ä¢ Posture: Normal</p>
      </div>
      <div class="flex gap-2">
        <button id="themeToggle" class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-slate-200 hover:bg-slate-300 dark:bg-slate-800 dark:hover:bg-slate-700 border border-slate-300 dark:border-slate-600 text-sm">
          üåô Dark
        </button>
        <button id="toggle" class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-slate-200 hover:bg-slate-300 dark:bg-slate-800 dark:hover:bg-slate-700 border border-slate-300 dark:border-slate-600 text-sm">
          ‚è∏ Pause
        </button>
      </div>
    </div>

    <div id="cards" class="grid md:grid-cols-3 gap-5 mt-6"></div>

    <div class="mt-6 text-xs text-slate-600 dark:text-slate-500">
      * Demo simulation only. Prices drift randomly to showcase card states (WAIT ‚Üí ENTERED ‚Üí SOLD 50% ‚Üí EXIT/STOP).
    </div>
  </div>

<script>
/* ---------- constants ---------- */
const STAGES={WAITING:'WAITING',ENTERED:'ENTERED',HALF_SOLD:'HALF_SOLD',EXITED:'EXITED',STOPPED:'STOPPED',EXPIRED:'EXPIRED',CANCELLED:'CANCELLED'};

// card color schemes (work in dark & light)
const colors={
  WAITING:'bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-700',
  ENTERED:'bg-emerald-50 dark:bg-emerald-900/20 border-emerald-300 dark:border-emerald-500/40',
  HALF_SOLD:'bg-amber-50 dark:bg-amber-900/20 border-amber-300 dark:border-amber-500/40',
  EXITED:'bg-cyan-50 dark:bg-cyan-900/20 border-cyan-300 dark:border-cyan-500/40',
  STOPPED:'bg-rose-50 dark:bg-rose-900/20 border-rose-300 dark:border-rose-500/40',
  EXPIRED:'bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-700 opacity-60',
  CANCELLED:'bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-700 opacity-50'
};

const seed=[
  {id:'A',symbol:'AAPL',quality:82,pattern:'Hammer @ 20-EMA',anchor:'H1 swing-low ‚àí0.25√óATR',entry:229.8,stop:227.3,last:228.2,atr:2.45,status:STAGES.WAITING, runner:'EMA9', ema9:228.00, ema10:227.90, ema20:227.40},
  {id:'B',symbol:'TSLA',quality:88,pattern:'7-bar Flag',anchor:'50-EMA ‚àí0.25√óATR',entry:252.1,stop:247.9,last:250.6,atr:4.1,status:STAGES.WAITING, runner:'EMA10', ema9:250.10, ema10:249.90, ema20:248.70},
  {id:'C',symbol:'NVDA',quality:73,pattern:'Channel-Top Break',anchor:'D1 shelf ‚àí0.40√óATR',entry:125.6,stop:122,last:124.7,atr:3.6,status:STAGES.WAITING, runner:'EMA20', ema9:124.40, ema10:124.20, ema20:123.60}
];

let cards=seed;
const history=Object.fromEntries(cards.map(c=>[c.id,[c.last]]));

/* ---------- helpers ---------- */
function fmt(n,d=2){return Number(n).toLocaleString(undefined,{minimumFractionDigits:d,maximumFractionDigits:d});}
function pct(x){return (x*100).toFixed(2)+'%';}
function R(entry,stop){return Math.max(entry-stop,0.0001);}
function sparkPath(arr,w=160,h=50){const max=Math.max(...arr),min=Math.min(...arr);return arr.map((v,i)=>{const x=(i/(arr.length-1))*w;const y=h-((v-min)/(max-min||1))*h;return `${i?'L':'M'}${x},${y}`;}).join(' ');}

/* ---------- rendering ---------- */
const root=document.getElementById('cards');

function statusBadge(s){
  const map = {
    WAITING: ["WAIT","bg-slate-700 text-white"],
    ENTERED: ["ENTERED","bg-emerald-600 text-white"],
    HALF_SOLD: ["SOLD 50%","bg-amber-600 text-white"],
    EXITED: ["EXITED","bg-cyan-600 text-white"],
    STOPPED: ["STOPPED","bg-rose-600 text-white"],
    EXPIRED: ["EXPIRED","bg-slate-600 text-white"],
    CANCELLED: ["CANCELLED","bg-slate-600 text-white"],
  };
  const [t,cls]=map[s]; return `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold ${cls}">${t}</span>`;
}

function render(){
  root.innerHTML=cards.map(c=>{
    const entryFill=c.entryFill??c.entry,r=R(entryFill,c.stop),rrNow=(c.last-entryFill)/r,t1Price=entryFill + 1*r;
    const realized=c.halfFill?0.5*((c.halfFill-entryFill)/entryFill):0;
    const open=[STAGES.ENTERED,STAGES.HALF_SOLD].includes(c.status)?((c.halfFill?0.5:1)*((c.last-entryFill)/entryFill)):0;
    const total=realized+open;
    const path=sparkPath(history[c.id]);

    // trail label
    const trailLabel = c.runner === 'EMA9' ? '9 EMA' : c.runner === 'EMA10' ? '10 EMA' : '20 EMA';

    return `
    <div class="relative border rounded-2xl p-4 ${colors[c.status]} card-shadow transition-colors">
      <div class="flex items-start justify-between">
        <div>
          <div class="text-slate-800 dark:text-slate-200 text-lg font-semibold">${c.symbol}</div>
          <div class="text-slate-600 dark:text-slate-400 text-xs">${c.pattern}</div>
        </div>
        <div class="text-right"><div class="text-2xl font-bold text-emerald-700 dark:text-indigo-300">${c.quality}</div><div class="text-slate-600 dark:text-slate-400 text-xs">Strong</div></div>
      </div>

      <div class="mt-3">
        <svg viewBox="0 0 160 50" class="w-full h-14">
          <path d="${path}" class="fill-none stroke-emerald-500 dark:stroke-emerald-400" stroke-width="2"/>
        </svg>
      </div>

      <div class="mt-3 grid grid-cols-2 gap-3 text-sm">
        <div>
          <div class="flex justify-between"><span class="text-slate-600 dark:text-slate-400">Last</span><span class="text-slate-900 dark:text-slate-100">$${fmt(c.last)}</span></div>
          <div class="flex justify-between"><span class="text-slate-600 dark:text-slate-400">Entry</span><span class="text-slate-900 dark:text-slate-100">$${fmt(c.entry)}</span></div>
          <div class="flex justify-between"><span class="text-slate-600 dark:text-slate-400">Stop</span><span class="text-rose-700 dark:text-rose-300">$${fmt(c.stop)}</span></div>
        </div>
        <div>
          <div class="flex justify-between"><span class="text-slate-600 dark:text-slate-400">T1</span><span class="text-slate-900 dark:text-slate-100">$${fmt(t1Price)}</span></div>
          <div class="flex justify-between"><span class="text-slate-600 dark:text-slate-400">ATR(14)</span><span class="text-slate-900 dark:text-slate-100">$${fmt(c.atr)}</span></div>
          <div class="flex justify-between"><span class="text-slate-600 dark:text-slate-400">R:R now</span><span class="text-slate-900 dark:text-slate-100">${fmt(rrNow)}R</span></div>
        </div>
      </div>

      <div class="mt-3 flex flex-col gap-2">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            ${statusBadge(c.status)}
            <span class="text-xs text-slate-600 dark:text-slate-400">Anchor: ${c.anchor}</span>
          </div>
          <div class="flex gap-2 items-center">
            <button class="likeBtn text-lg" title="Like" data-id="${c.id}">üëç</button>
            <button class="disBtn text-lg" title="Dislike" data-id="${c.id}">üëé</button>
          </div>
        </div>

        <div class="flex items-center justify-between gap-3">
          <label class="text-xs text-slate-700 dark:text-slate-300">Runner Trail:</label>
          <select class="trailSel flex-1 text-xs px-2 py-1 rounded bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-slate-100"
                  data-id="${c.id}">
            <option value="EMA9"  ${c.runner==='EMA9'?'selected':''}>9 EMA (fast)</option>
            <option value="EMA10" ${c.runner==='EMA10'?'selected':''}>10 EMA</option>
            <option value="EMA20" ${c.runner==='EMA20'?'selected':''}>20 EMA (max)</option>
          </select>
          <span class="text-xs text-slate-600 dark:text-slate-400">Active: ${trailLabel}</span>
        </div>
      </div>

      <div class="feedback-popup" id="fb-${c.id}">
        <textarea placeholder="Leave feedback..." class="w-full text-xs p-1 rounded bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-slate-100"></textarea>
        <button class="mt-1 w-full bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 rounded text-xs py-1" data-save="${c.id}">Submit</button>
      </div>

      <div class="mt-3 grid grid-cols-3 gap-3 text-xs">
        <div class="rounded-xl p-2 bg-slate-100 dark:bg-slate-900/40">
          <div class="text-slate-600 dark:text-slate-400">Realized</div><div class="text-slate-900 dark:text-slate-100">${pct(realized)}</div>
        </div>
        <div class="rounded-xl p-2 bg-slate-100 dark:bg-slate-900/40">
          <div class="text-slate-600 dark:text-slate-400">Open</div><div class="text-slate-900 dark:text-slate-100">${pct(open)}</div>
        </div>
        <div class="rounded-xl p-2 bg-slate-100 dark:bg-slate-900/40">
          <div class="text-slate-600 dark:text-slate-400">Total</div><div class="text-slate-900 dark:text-slate-100">${pct(total)}</div>
        </div>
      </div>
    </div>`;
  }).join('');

  attachFeedback();
  attachTrailSelectors();
}

/* ---------- feedback logic ---------- */
function attachFeedback(){
  document.querySelectorAll('.likeBtn,.disBtn').forEach(btn=>{
    btn.onclick=(e)=>{
      const id=e.currentTarget.dataset.id;
      const popup=document.getElementById('fb-'+id);
      popup.style.display='block';
      popup.querySelector('textarea').focus();
    };
  });
  document.querySelectorAll('[data-save]').forEach(btn=>{
    btn.onclick=(e)=>{
      const id=e.currentTarget.dataset.save;
      const popup=document.getElementById('fb-'+id);
      const comment=popup.querySelector('textarea').value.trim();
      if(comment){ console.log('Feedback for',id,':',comment); alert('Feedback saved!'); }
      popup.style.display='none';
      popup.querySelector('textarea').value='';
    };
  });
}

/* ---------- trailing EMA selector ---------- */
function attachTrailSelectors(){
  document.querySelectorAll('.trailSel').forEach(sel=>{
    sel.onchange=(e)=>{
      const id=e.currentTarget.dataset.id;
      const value=e.currentTarget.value; // EMA9 | EMA10 | EMA20
      const idx=cards.findIndex(c=>c.id===id);
      if(idx>-1){ cards[idx].runner=value; }
      render(); // refresh active label
    };
  });
}

/* ---------- simulation / state machine ---------- */
function tick(){
  cards=cards.map(c=>{
    // price drift
    const drift=(Math.random()-0.45)*(c.atr/40);
    const last=+(c.last+drift).toFixed(2);
    // cheap EMAs
    const ema9  = +(0.20*last + 0.80*(c.ema9 ?? last)).toFixed(2);
    const ema10 = +(0.18*last + 0.82*(c.ema10 ?? last)).toFixed(2);
    const ema20 = +(0.10*last + 0.90*(c.ema20 ?? last)).toFixed(2);

    const next={...c,last,ema9,ema10,ema20};

    // spark history
    const arr=history[c.id] || (history[c.id]=[]);
    arr.push(last); if(arr.length>60)arr.shift();

    return next;
  });

  // First-to-trigger
  const haveWinner = cards.some(c => ![STAGES.WAITING, STAGES.CANCELLED].includes(c.status));
  if(!haveWinner){
    const triggered = cards.filter(c => c.status===STAGES.WAITING && c.last >= c.entry);
    if(triggered.length){
      const first = triggered[0];
      first.status = STAGES.ENTERED;
      first.enteredAt = Date.now();
      first.entryFill = first.last;
      // cancel others
      cards.forEach(c=>{ if(c.id!==first.id && c.status===STAGES.WAITING) c.status = STAGES.CANCELLED; });
    }
  }

  // Manage live trade (risk-to-flat)
  const live = cards.find(c => [STAGES.ENTERED, STAGES.HALF_SOLD].includes(c.status));
  if(live){
    const entryFill = live.entryFill ?? live.entry;
    const r = R(entryFill, live.stop);
    const t1Price = entryFill + 1*r; // +1R partial

    if(live.status===STAGES.ENTERED && live.last >= t1Price){
      live.status = STAGES.HALF_SOLD;
      live.halfSoldAt = Date.now();
      live.halfFill = live.last;
    }
    // stop at breakeven after half
    if(live.status===STAGES.HALF_SOLD && live.last <= entryFill){
      live.status = STAGES.STOPPED;
      live.exitAt = Date.now();
      live.exitFill = entryFill;
    }
    // EMA trail after half using selected runner
    if(live.status===STAGES.HALF_SOLD){
      const trail = live.runner==="EMA9" ? live.ema9 : live.runner==="EMA10" ? live.ema10 : live.ema20;
      if(live.last < trail){
        live.status = STAGES.EXITED;
        live.exitAt = Date.now();
        live.exitFill = live.last;
      }
    }
  }

  render();
}

let running=true,handle=setInterval(tick,900);
document.getElementById('toggle').onclick=()=>{
  running=!running;
  if(running){handle=setInterval(tick,900);document.getElementById('toggle').textContent='‚è∏ Pause';}
  else{clearInterval(handle);document.getElementById('toggle').textContent='‚ñ∂ Resume';}
};

/* ---------- dark / light toggle ---------- */
const themeBtn = document.getElementById('themeToggle');
themeBtn.onclick = () => {
  const el = document.documentElement;
  const isDark = el.classList.contains('dark');
  if (isDark) {
    el.classList.remove('dark');
    themeBtn.textContent = '‚òÄÔ∏è Light';
  } else {
    el.classList.add('dark');
    themeBtn.textContent = 'üåô Dark';
  }
};

render();
</script>
</body>
</html>
