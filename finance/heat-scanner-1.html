<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Heat‑Check Director — Full Dashboard (Static Demo)</title>
  <style>
    :root{
      --bg:#0b0f16; --panel:#0f1623; --muted:#7a8499; --text:#e7edf6; --brand:#60a5fa;
      --hot:#ef4444; --warm:#f59e0b; --icy:#38bdf8; --cold:#94a3b8; --card:#121a2a; --accent:#1f2b45;
      --green:#10b981; --red:#ef4444; --rose:#f43f5e; --emerald:#34d399; --amber:#f59e0b; --sky:#38bdf8;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial; background:linear-gradient(180deg,#0a0f18,#0b1220 60%,#0a1020); color:var(--text)}
    a{color:inherit}
    .wrap{max-width:1260px;margin:0 auto;padding:24px}
    .row{display:grid;gap:16px}
    .row.cols-2{grid-template-columns:1fr 1fr}
    .row.cols-3{grid-template-columns:1fr 1fr 1fr}
    .row.cols-4{grid-template-columns:1fr 1fr 1fr 1fr}
    .card{background:var(--panel); border:1px solid #1e2a42; border-radius:16px; box-shadow:0 6px 24px rgb(0 0 0 / 0.25)}
    .card .hd{padding:14px 16px 0}
    .card .bd{padding:12px 16px 16px}
    h1{font-size:22px;margin:0}
    .muted{color:var(--muted)}
    .kpi{padding:12px 16px}
    .kpi .label{font-size:11px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted)}
    .kpi .value{font-size:24px;font-weight:700;display:flex;align-items:center;gap:8px}
    .stage-pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:600}
    .stage-Hot{background:rgba(239,68,68,.15);color:#fecaca;border:1px solid rgba(239,68,68,.35)}
    .stage-Warm{background:rgba(245,158,11,.18);color:#fde68a;border:1px solid rgba(245,158,11,.35)}
    .stage-Icy{background:rgba(56,189,248,.18);color:#bae6fd;border:1px solid rgba(56,189,248,.35)}
    .stage-Cold{background:rgba(148,163,184,.20);color:#e2e8f0;border:1px solid rgba(148,163,184,.35)}
    .chips{display:flex;gap:10px;flex-wrap:wrap}
    .chip{background:var(--card);border:1px solid #26324d;border-radius:12px;padding:8px 10px;font-size:13px;color:#cdd7ea}
    .chip b{color:#fff}
    .handoff{display:flex;align-items:center;gap:10px;background:linear-gradient(90deg,var(--accent),#213257);border:1px solid #26324d;border-radius:14px;padding:12px 14px}
    .btn-tab{background:#0f1729;border:1px solid #223052;color:#cbd5e1;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn-tab.active{background:#1a2440;color:#fff}
    .tabs{display:flex;gap:8px}
    .grid-bars{display:grid;grid-template-columns:repeat(5,minmax(140px,1fr));gap:10px}
    .bar{height:8px;background:#1e293b;border-radius:999px;overflow:hidden}
    .bar > span{display:block;height:100%;background:linear-gradient(90deg,#93c5fd,#60a5fa);}    
    .bar-val{font-size:12px;color:#cbd5e1;margin-top:6px}
    .news-item{display:flex;gap:10px}
    .badge{font-weight:600;font-size:12px;border-radius:999px;padding:4px 8px}
    .badge.pos{background:rgba(34,197,94,.15);color:#bbf7d0;border:1px solid rgba(34,197,94,.35)}
    .badge.neg{background:rgba(244,63,94,.15);color:#fecdd3;border:1px solid rgba(244,63,94,.35)}
    .area{width:100%;height:260px;background:linear-gradient(180deg,#0d1424,#0b0f16);border:1px solid #223052;border-radius:12px;position:relative}
    .chart-abs{position:absolute;inset:0}
    .legend{display:flex;gap:10px;flex-wrap:wrap}
    .legend span{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:#cbd5e1}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.vol{background:#93c5fd}.dot.breadth{background:#38bdf8}.dot.credit{background:#34d399}.dot.trend{background:#22d3ee}.dot.news{background:#f59e0b}
    .timeline{display:flex;gap:2px;height:14px}
    .tl-Cold{background:var(--cold)}.tl-Icy{background:var(--icy)}.tl-Warm{background:var(--warm)}.tl-Hot{background:var(--hot)}
    .footer{font-size:12px;color:#93a3bf;margin-top:14px}

    /* Tables */
    table{border-collapse:separate;border-spacing:0;width:100%}
    th,td{padding:10px 12px;text-align:left}
    thead tr{background:#101a2d;color:#cbd5e1}
    tbody tr{background:#0f1623;border-top:1px solid #1e2a42}
    tbody tr:hover{background:#13203a}
    .sortable{cursor:pointer}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:3px 8px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,.12)}
    .pill.l{background:rgba(16,185,129,.15);color:#bbf7d0}
    .pill.s{background:rgba(239,68,68,.15);color:#fecaca}

    /* QS badge */
    .qs{display:inline-flex;align-items:center;gap:6px;padding:3px 8px;border-radius:10px;font-size:12px;font-weight:700}
    .qs.h{background:rgba(16,185,129,.12);color:#34d399;border:1px solid rgba(16,185,129,.3)}
    .qs.m{background:rgba(245,158,11,.12);color:#fbbf24;border:1px solid rgba(245,158,11,.3)}
    .qs.l{background:rgba(244,63,94,.12);color:#fb7185;border:1px solid rgba(244,63,94,.3)}

    .hint{font-size:12px;color:#e9d5ff;background:rgba(124,58,237,.15);border:1px solid rgba(124,58,237,.35);padding:8px 10px;border-radius:10px}

    /* Layout helpers */
    .flex{display:flex}.between{justify-content:space-between}.items-center{align-items:center}.gap-2{gap:8px}.gap-3{gap:12px}.gap-4{gap:16px}
    .mt-1{margin-top:6px}.mt-2{margin-top:10px}.mt-3{margin-top:14px}.mt-4{margin-top:18px}.mt-6{margin-top:24px}
    .mb-2{margin-bottom:10px}
    .btn{background:#0f1729;border:1px solid #223052;color:#cbd5e1;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{background:#162344}
    .tag{display:inline-block;border:1px solid #203155;border-radius:8px;padding:6px 8px;font-size:12px;color:#d6e2fb;margin:2px;cursor:pointer}
    .tag.active{background:#1a2a4a}

    /* Small axis labels for charts */
    .axis-label{fill:#9fb3d9;font-size:11px}
    .grid-line{stroke:#1f2a42;stroke-width:1;opacity:.55}
    /* Mobile responsiveness */
    .table-wrap{overflow-x:auto;}
    @media (max-width:1100px){
      .row.cols-4{grid-template-columns:1fr 1fr}
      .row.cols-3{grid-template-columns:1fr 1fr}
      .area{height:220px}
      .wrap{padding:16px}
    }
    @media (max-width:700px){
      .row.cols-4,.row.cols-3,.row.cols-2{grid-template-columns:1fr}
      h1{font-size:18px}
      .tabs{flex-wrap:wrap}
      table{min-width:640px}
      .grid-bars{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <div class="row" style="grid-template-columns:auto 1fr auto; align-items:center; gap:16px;">
      <div style="display:flex; align-items:center; gap:10px">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none"><path d="M12 2L3 7v10l9 5 9-5V7l-9-5z" stroke="#60a5fa" stroke-width="1.4"/><path d="M12 2v20" stroke="#60a5fa" stroke-width="1.2" opacity=".6"/></svg>
        <div>
          <h1>Heat‑Check Director — Full Dashboard</h1>
          <div class="muted" style="font-size:12px">Static demo — dummy values only. No network calls.</div>
        </div>
      </div>
      <div></div>
      <div class="tabs">
        <button class="btn-tab" data-mode="intraday">Intraday</button>
        <button class="btn-tab active" data-mode="eod">EOD</button>
        <button class="btn-tab" data-mode="weekly">Weekly</button>
        <button id="btn-beginner" class="btn" style="margin-left:8px">Beginner Mode: OFF</button>
      </div>
    </div>

    <div style="height:14px"></div>

    <!-- KPIs row -->
    <div class="row cols-4">
      <div class="card">
        <div class="kpi">
          <div class="label">Stage</div>
          <div class="value"><span id="stage-pill" class="stage-pill stage-Warm">Warm</span></div>
        </div>
      </div>
      <div class="card"><div class="kpi"><div class="label">Composite Heat Score</div><div class="value" id="kpi-chs">61/100</div></div></div>
      <div class="card"><div class="kpi"><div class="label">Tilt (Δ5d)</div><div class="value" id="kpi-tilt">+4</div></div></div>
      <div class="card"><div class="kpi"><div class="label">News Score (proxy)</div><div class="value" id="kpi-ns">+3</div></div></div>
    </div>

    <!-- Term structure + Handoff -->
    <div style="height:14px"></div>
    <div class="row cols-3">
      <div class="card">
        <div class="hd"><div class="muted" style="font-size:12px">Volatility Term Structure</div></div>
        <div class="bd">
          <div class="chips">
            <div class="chip">State: <b id="term-state">Contango</b></div>
            <div class="chip">VIX: <b id="vix">15.7</b></div>
            <div class="chip">VIX3M: <b id="vix3m">18.9</b></div>
            <div class="chip">VIX9D: <b id="vix9d">15.1</b></div>
          </div>
        </div>
      </div>
      <div class="card" style="grid-column: span 2">
        <div class="bd">
          <div class="handoff">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M5 12h14M13 5l7 7-7 7" stroke="#93c5fd" stroke-width="1.6"/></svg>
            <div>
              <div class="muted" style="font-size:12px">Director Handoff</div>
              <div id="handoff" style="font-size:16px;font-weight:700">Load Momentum Swing Warm Bull</div>
              <div class="muted" style="font-size:12px">One‑line brief: next module runs the swing screeners; Director stays classification‑only.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts row -->
    <div style="height:14px"></div>
    <div class="row cols-3">
      <div class="card" style="grid-column: span 2">
        <div class="hd"><div class="muted" style="font-size:12px">Composite Heat Score</div></div>
        <div class="bd">
          <div class="area">
            <svg id="chs-svg" class="chart-abs" viewBox="0 0 1000 260" preserveAspectRatio="none"></svg>
          </div>
          <div id="chs-stats" class="muted" style="font-size:12px;margin-top:8px">Stats: —</div>
        </div>
      </div>
      <div class="card">
        <div class="hd"><div class="muted" style="font-size:12px">Subscores (latest)</div></div>
        <div class="bd">
          <div class="grid-bars">
            <div>
              <div class="muted" style="font-size:12px;margin-bottom:6px">Vol</div>
              <div class="bar"><span id="bar-vol" style="width:72%"></span></div>
              <div id="val-vol" class="bar-val">72 (w 25%) → 18.0</div>
            </div>
            <div>
              <div class="muted" style="font-size:12px;margin-bottom:6px">Breadth</div>
              <div class="bar"><span id="bar-breadth" style="width:64%"></span></div>
              <div id="val-breadth" class="bar-val">64 (w 27%) → 17.3</div>
            </div>
            <div>
              <div class="muted" style="font-size:12px;margin-bottom:6px">Credit</div>
              <div class="bar"><span id="bar-credit" style="width:55%"></span></div>
              <div id="val-credit" class="bar-val">55 (w 15%) → 8.3</div>
            </div>
            <div>
              <div class="muted" style="font-size:12px;margin-bottom:6px">Trend</div>
              <div class="bar"><span id="bar-trend" style="width:68%"></span></div>
              <div id="val-trend" class="bar-val">68 (w 23%) → 15.6</div>
            </div>
            <div>
              <div class="muted" style="font-size:12px;margin-bottom:6px">News</div>
              <div class="bar"><span id="bar-news" style="width:52%"></span></div>
              <div id="val-news" class="bar-val">52 (w 10%) → 5.2</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Lines & Timeline -->
    <div style="height:14px"></div>
    <div class="row cols-2">
      <div class="card">
        <div class="hd"><div class="muted" style="font-size:12px">Blocks Over Time</div></div>
        <div class="bd">
          <div class="legend" style="margin-bottom:8px">
            <span><span class="dot vol"></span>Vol</span>
            <span><span class="dot breadth"></span>Breadth</span>
            <span><span class="dot credit"></span>Credit</span>
            <span><span class="dot trend"></span>Trend</span>
            <span><span class="dot news"></span>News</span>
          </div>
          <div class="area" style="height:240px">
            <svg id="blocks-svg" class="chart-abs" viewBox="0 0 1000 240" preserveAspectRatio="none"></svg>
          </div>
          <div id="blocks-axis" class="muted" style="font-size:12px;margin-top:8px">Timeline: —</div>
        </div>
      </div>
      <div class="card">
        <div class="hd"><div class="muted" style="font-size:12px">Stage Timeline</div></div>
        <div class="bd">
          <div id="timeline" class="timeline"></div>
          <div id="timeline-legend" class="muted" style="font-size:12px;margin-top:8px">—</div>
        </div>
      </div>
    </div>

    <!-- ===== Trader Workspace ===== -->
    <div class="mt-6"></div>
    <div class="flex between items-center mb-2">
      <div class="flex items-center gap-3">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M4 6h16M4 12h16M4 18h16" stroke="#9fb3d9" stroke-width="1.6"/></svg>
        <h2 style="margin:0;font-size:18px">Trader Workspace</h2>
        <span id="hint-beginner" class="hint" style="display:none">Beginner tip: Click any row to see Entry / Stop / T1 / Runner in the Inspector.</span>
      </div>
      <div>
        <span class="muted" style="font-size:12px;margin-right:8px">Quick Filters:</span>
        <span class="tag" data-filter="screener:MOMO">MOMO</span>
        <span class="tag" data-filter="screener:FLAG">FLAG</span>
        <span class="tag" data-filter="screener:REV">REV</span>
        <span class="tag" data-filter="side:Long">Longs</span>
        <span class="tag" data-filter="side:Short">Shorts</span>
      </div>
    </div>

    <div class="row cols-3">
      <!-- Market Overview (replaces Watchlist) -->
      <div class="card">
        <div class="hd"><div style="display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M3 12l6 6L21 6" stroke="#93c5fd" stroke-width="1.6"/></svg><div class="muted" style="font-size:12px">Market Overview</div></div></div>
        <div class="bd">
          <div class="table-wrap">
            <table id="tbl-market">
              <thead><tr>
                <th>Instrument</th>
                <th>Last</th>
                <th>%Chg</th>
                <th>20‑d Trend</th>
                <th>Note</th>
              </tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Top Trades -->
      <div class="card" style="grid-column: span 2">
        <div class="hd"><div style="display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M4 12l6 6L20 6" stroke="#34d399" stroke-width="1.6"/></svg><div class="muted" style="font-size:12px">Top Stocks to Trade (Demo)</div></div></div>
        <div class="bd">
          <div class="table-wrap">
            <table id="tbl-trades">
              <thead><tr>
                <th class="sortable" data-sort="ticker">Ticker</th>
                <th>Screener</th>
                <th>Stage</th>
                <th>Side</th>
                <th>Setup</th>
                <th class="sortable" data-sort="entry">Entry</th>
                <th class="sortable" data-sort="stop">Stop</th>
                <th class="sortable" data-sort="t1">T1</th>
                <th>Runner</th>
                <th class="sortable" data-sort="rr">R:R</th>
                <th class="sortable" data-sort="quality">QS</th>
              </tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Screener + Inspector -->
    <div class="mt-4"></div>
    <div class="row cols-3">
      <div class="card" style="grid-column: span 2">
        <div class="hd"><div class="muted" style="font-size:12px">Market Screener (Demo)</div></div>
        <div class="bd">
          <div class="flex gap-3 mb-2">
            <div>
              <div class="muted" style="font-size:12px">Screener</div>
              <div>
                <span class="tag" data-filter="screener:MOMO">MOMO</span>
                <span class="tag" data-filter="screener:FLAG">FLAG</span>
                <span class="tag" data-filter="screener:REV">REV</span>
              </div>
            </div>
            <div>
              <div class="muted" style="font-size:12px">Side</div>
              <div>
                <span class="tag" data-filter="side:Long">Long</span>
                <span class="tag" data-filter="side:Short">Short</span>
              </div>
            </div>
            <div>
              <div class="muted" style="font-size:12px">QS</div>
              <div>
                <span class="tag" data-filter="qs:80+">80+</span>
                <span class="tag" data-filter="qs:60-79">60–79</span>
                <span class="tag" data-filter="qs:lt60">&lt;60</span>
              </div>
            </div>
            <div style="align-self:flex-end"><button id="btn-clear" class="btn">Clear Filters</button></div>
          </div>
          <div class="table-wrap">
            <table id="tbl-screen">
              <thead><tr>
                <th>Ticker</th>
                <th>Screener</th>
                <th>Stage</th>
                <th>Side</th>
                <th>Setup</th>
                <th>Entry</th>
                <th>Stop</th>
                <th>T1</th>
                <th>Runner</th>
                <th>R:R</th>
                <th>QS</th>
              </tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="hd"><div class="muted" style="font-size:12px">Inspector</div></div>
        <div class="bd" id="inspector">
          <div class="muted" style="font-size:13px">Click a row to preview a trade idea.</div>
        </div>
      </div>
    </div>

    <!-- News & Triggers -->
    <div class="mt-6"></div>
    <div class="row cols-3">
      <div class="card" style="grid-column: span 2">
        <div class="hd"><div class="muted" style="font-size:12px">News Deck (demo)</div></div>
        <div class="bd" id="news-list"></div>
      </div>
      <div class="card">
        <div class="hd"><div class="muted" style="font-size:12px">If / Then Triggers (next 1–3 sessions)</div></div>
        <div class="bd">
          <ul style="margin:0;padding-left:18px;line-height:1.7">
            <li>If VIX > VIX3M for 2 closes → downgrade to Icy.</li>
            <li>If %SPX>50‑DMA &lt; 50% → downgrade to Icy.</li>
            <li>If HYG/TLT 5‑day ROC &lt; −1% → cut Credit block one tier.</li>
            <li>If NS ≤ −25 on CPI/FOMC → immediate Icy override.</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="footer">Demo only. To wire this to your engine, bind DOM setters to your Director API or local JSON snapshots. Nothing here is investment advice.</div>
  </div>

<script>
(function(){
  // --- Dummy generators (no external pulls) ---
  function genSeries(days, seed){
    var out=[], chs=seed||61; var i, d, drift, vol,breadth,credit,trend,news,stage;
    for(i=days-1;i>=0;i--){
      d=new Date(); d.setDate(d.getDate()-i);
      drift=(Math.sin(i/9)+Math.cos(i/5))*2;
      chs=Math.max(10,Math.min(90,chs+(Math.random()-0.5)*5+drift*0.3));
      vol=60+Math.sin(i/4)*15+(Math.random()-0.5)*8;
      breadth=55+Math.cos(i/6)*20+(Math.random()-0.5)*10;
      credit=50+Math.sin(i/7)*18+(Math.random()-0.5)*8;
      trend=58+Math.cos(i/8)*16+(Math.random()-0.5)*6;
      news=50+Math.sin(i/10)*14+(Math.random()-0.5)*10;
      stage="Warm"; if(chs>=65)stage="Hot"; else if(chs<35)stage="Cold"; else if(chs<50)stage="Icy";
      out.push({date:d.toISOString(),chs:Math.round(chs),vol:~~vol,breadth:~~breadth,credit:~~credit,trend:~~trend,news:~~news,stage:stage});
    }
    return out;
  }
  var DATA={
    eod:{ series: genSeries(90,62), ns: +3, term:{vix:15.7,vix3m:18.9,vix9d:15.1} },
    intraday:{ series: genSeries(60,58), ns: +1, term:{vix:16.1,vix3m:19.0,vix9d:16.3} },
    weekly:{ series: genSeries(52,60), ns: 0, term:{vix:15.4,vix3m:18.6,vix9d:14.9} }
  };

  // Market overview dummy data with simple sparklines
  var MARKET=[
    { name:"S&P 500", code:"SPX", last:5534.1, chg:+0.6, note:"Above 50/200‑DMA", spark: genSpark(20, 0.4) },
    { name:"Nasdaq 100", code:"NDX", last:20012.4, chg:+0.9, note:"Leadership intact", spark: genSpark(20, 0.7) },
    { name:"Russell 2000", code:"IWM", last:201.8, chg:-0.2, note:"Small‑cap lag", spark: genSpark(20, -0.2) },
    { name:"VIX", code:"VIX", last:15.7, chg:-4.1, note:"Contango", spark: genSpark(20, -0.5) },
    { name:"Fear Grade", code:"FGI", last:62, chg:+3.0, note:"Greed", spark: genSpark(20, 0.2) }
  ];

  // Screener output with Screener + Stage + QS
  var TOP_TRADES=[
    { screener:"MOMO", stage:"Hot", ticker:"NVDA", side:"Long", setup:"Flag breakout", entry:128.2, stop:124.9, t1:133.0, runner:"10EMA", rr:1.6, quality:89 },
    { screener:"PEG",  stage:"Warm", ticker:"AAPL", side:"Long", setup:"Pullback to 20SMA", entry:232.5, stop:228.9, t1:238.0, runner:"20EMA", rr:1.5, quality:78 },
    { screener:"REV",  stage:"Icy",  ticker:"TSLA", side:"Short", setup:"Failed retest", entry:260.0, stop:266.5, t1:247.0, runner:"10EMA", rr:1.9, quality:74 },
    { screener:"FLAG", stage:"Hot", ticker:"SMH",  side:"Long", setup:"Breadth thrust", entry:266.8, stop:261.0, t1:275.5, runner:"10EMA", rr:1.7, quality:83 },
    { screener:"REV",  stage:"Cold", ticker:"IWM",  side:"Short", setup:"Bear flag", entry:202.2, stop:206.8, t1:195.4, runner:"20EMA", rr:1.6, quality:69 }
  ];

  var newsDeck=[
    {tag:"[V] Rates/Liquidity",score:+6,headline:"Powell hints at cut if disinflation continues",source:"Reuters",t:new Date().toLocaleString()},
    {tag:"[V] Micro",score:+3,headline:"Mega‑cap beats; buybacks extended",source:"FT",t:new Date(Date.now()-2*3600000).toLocaleString()},
    {tag:"[V] Inflation",score:-2,headline:"PPI a touch hot; services up",source:"WSJ",t:new Date(Date.now()-8*3600000).toLocaleString()},
    {tag:"[D] Geo/Energy",score:-3,headline:"Oil firm on supply chatter; OPEC in focus",source:"Bloomberg",t:new Date(Date.now()-10*3600000).toLocaleString()}
  ];

  var mode="eod", beginner=false, activeFilters=[];

  function $(id){return document.getElementById(id)}
  function fmt(n){return (n>0?"+":"")+n}
  function money(n){return "$"+n.toFixed(2)}
  function qsClass(q){return q>=80?'qs h':(q>=60?'qs m':'qs l')}

  function contrib(v,w){ v=Math.max(0,Math.min(100,v)); return (v*w).toFixed(1); }
  function derive(series){
    var last=series[series.length-1];
    var idx=Math.max(0,series.length-6); var tilt=last.chs-series[idx].chs;
    var ns=DATA[mode].ns; var term=DATA[mode].term; var contango=term.vix < term.vix3m;
    var stage=last.stage; // from generator
    return {last:last, tilt:tilt, ns:ns, term:term, contango:contango, stage:stage, series:series};
  }

  function handoffFor(stage){
    if(stage==='Hot')return 'Load Momentum Swing Hot Bull';
    if(stage==='Warm')return 'Load Momentum Swing Warm Bull';
    if(stage==='Icy')return 'Momentum Swing Icy Bear';
    return 'Momentum Swing Cold Bear';
  }

  // --------- Renders ---------
  function render(){
    var s=DATA[mode].series, d=derive(s), last=d.last;

    // KPIs
    $("kpi-chs").textContent=last.chs+"/100";
    $("kpi-tilt").textContent=fmt(Math.round(d.tilt));
    $("kpi-ns").textContent=fmt(d.ns);

    // Stage pill & handoff
    var pill=$("stage-pill"); pill.textContent=d.stage; pill.className='stage-pill stage-'+d.stage;
    $("handoff").textContent=handoffFor(d.stage);

    // Term chips
    $("term-state").textContent=d.contango?"Contango":"Backwardation";
    $("vix").textContent=d.term.vix.toFixed(1); $("vix3m").textContent=d.term.vix3m.toFixed(1); $("vix9d").textContent=d.term.vix9d.toFixed(1);

    // Subscore bars + numbers
    $("bar-vol").style.width=Math.min(100,Math.max(0,last.vol))+"%"; $("val-vol").textContent=last.vol+" (w 25%) → "+contrib(last.vol,0.25);
    $("bar-breadth").style.width=Math.min(100,Math.max(0,last.breadth))+"%"; $("val-breadth").textContent=last.breadth+" (w 27%) → "+contrib(last.breadth,0.27);
    $("bar-credit").style.width=Math.min(100,Math.max(0,last.credit))+"%"; $("val-credit").textContent=last.credit+" (w 15%) → "+contrib(last.credit,0.15);
    $("bar-trend").style.width=Math.min(100,Math.max(0,last.trend))+"%"; $("val-trend").textContent=last.trend+" (w 23%) → "+contrib(last.trend,0.23);
    $("bar-news").style.width=Math.min(100,Math.max(0,last.news))+"%"; $("val-news").textContent=last.news+" (w 10%) → "+contrib(last.news,0.10);

    // Charts with axes and stats
    drawArea('chs-svg', s.map(function(p){return p.chs;}), {fill:'rgba(96,165,250,0.18)', stroke:'#93c5fd'}, d);
    var chsMin = Math.min.apply(null, s.map(function(p){return p.chs;}));
    var chsMax = Math.max.apply(null, s.map(function(p){return p.chs;}));
    var chsAvg = (s.reduce(function(a,b){return a+b.chs;},0)/s.length).toFixed(1);
    $("chs-stats").textContent = "Stats: Min "+chsMin+" | Max "+chsMax+" | Avg "+chsAvg+" | Last "+last.chs+" | 5d Δ "+fmt(Math.round(d.tilt));

    drawLines('blocks-svg', {
      vol: s.map(function(p){return p.vol;}),
      breadth: s.map(function(p){return p.breadth;}),
      credit: s.map(function(p){return p.credit;}),
      trend: s.map(function(p){return p.trend;}),
      news: s.map(function(p){return p.news;})
    }, d);

    // Stage timeline + legend
    var tl=$("timeline"); tl.innerHTML='';
    var counts={Hot:0,Warm:0,Icy:0,Cold:0};
    for(var i=0;i<s.length;i++){var st=s[i].stage; counts[st]++; var seg=document.createElement('div'); seg.style.flex='1'; seg.className='tl-'+st; tl.appendChild(seg);}    
    var cur=s[s.length-1].stage, streak=1; for(var k=s.length-2;k>=0;k--){ if(s[k].stage===cur) streak++; else break; }
    var pct=function(n){return Math.round(n/s.length*100)};
    $("timeline-legend").textContent = 'Hot '+pct(counts.Hot)+'% | Warm '+pct(counts.Warm)+'% | Icy '+pct(counts.Icy)+'% | Cold '+pct(counts.Cold)+'%  • Current: '+cur+' ('+streak+' d)';

    // Tables
    renderMarket();
    renderTrades();
    renderScreen();

    // News
    var nl=$("news-list"); nl.innerHTML='';
    for(var j=0;j<newsDeck.length;j++){
      var it=newsDeck[j]; var row=document.createElement('div'); row.className='news-item';
      var badge=document.createElement('span'); badge.className='badge '+(it.score>=0?'pos':'neg'); badge.textContent=(it.score>=0?'+':'')+it.score;
      var txt=document.createElement('div'); txt.innerHTML='<div><b>'+it.tag+'</b> — '+it.headline+'</div><div class="muted" style="font-size:12px">'+it.source+' • '+it.t+'</div>';
      row.appendChild(badge); row.appendChild(txt); nl.appendChild(row);
    }

    // Beginner hint
    $("hint-beginner").style.display = beginner? 'inline-flex' : 'none';
  }

  function renderMarket(){
    var tb=$("tbl-market").querySelector('tbody'); tb.innerHTML='';
    for(var i=0;i<MARKET.length;i++){
      var r=MARKET[i]; var tr=document.createElement('tr');
      tr.innerHTML='<td>'+r.name+'</td>'+
                   '<td>'+(r.code==='FGI'? r.last.toFixed(0): (r.code==='VIX'? r.last.toFixed(1): r.last.toFixed(2)))+'</td>'+
                   '<td><span style="color:'+(r.chg>=0?'#34d399':'#fb7185')+'">'+(r.chg>=0?'+':'')+r.chg.toFixed(1)+'%</span></td>'+
                   '<td><svg width="120" height="26">'+sparkPath(r.spark)+'</svg></td>'+
                   '<td>'+r.note+'</td>';
      tb.appendChild(tr);
    }
  }

  function renderTrades(){
    var tb=$("tbl-trades").querySelector('tbody'); tb.innerHTML='';
    var list = applyFilters(TOP_TRADES.slice());
    for(var i=0;i<list.length;i++){
      var r=list[i]; var tr=document.createElement('tr'); tr.setAttribute('data-ticker',r.ticker);
      var pill='<span class="pill '+(r.side==='Long'?'l':'s')+'">'+r.side+'</span>';
      var qsb='<span class="'+qsClass(r.quality)+'">QS '+r.quality+'</span>';
      tr.innerHTML='<td>'+r.ticker+'</td>'+
                   '<td>'+r.screener+'</td>'+
                   '<td>'+r.stage+'</td>'+
                   '<td>'+pill+'</td>'+
                   '<td>'+r.setup+'</td>'+
                   '<td>'+money(r.entry)+'</td>'+
                   '<td>'+money(r.stop)+'</td>'+
                   '<td>'+money(r.t1)+'</td>'+
                   '<td>'+r.runner+'</td>'+
                   '<td>'+r.rr.toFixed(1)+'</td>'+
                   '<td>'+qsb+'</td>';
      tr.addEventListener('click', (function(r){return function(){ selectRow({ type:'trade', data:r }); };})(r));
      tb.appendChild(tr);
    }
  }

  function renderScreen(){
    var tb=$("tbl-screen").querySelector('tbody'); tb.innerHTML='';
    var list = applyFilters(TOP_TRADES.slice());
    for(var i=0;i<list.length;i++){
      var r=list[i]; var tr=document.createElement('tr');
      var qsb='<span class="'+qsClass(r.quality)+'">QS '+r.quality+'</span>';
      var pill='<span class="pill '+(r.side==='Long'?'l':'s')+'">'+r.side+'</span>';
      tr.innerHTML='<td>'+r.ticker+'</td>'+
                   '<td>'+r.screener+'</td>'+
                   '<td>'+r.stage+'</td>'+
                   '<td>'+pill+'</td>'+
                   '<td>'+r.setup+'</td>'+
                   '<td>'+money(r.entry)+'</td>'+
                   '<td>'+money(r.stop)+'</td>'+
                   '<td>'+money(r.t1)+'</td>'+
                   '<td>'+r.runner+'</td>'+
                   '<td>'+r.rr.toFixed(1)+'</td>'+
                   '<td>'+qsb+'</td>';
      tr.addEventListener('click', (function(r){return function(){ selectRow({ type:'trade', data:r }); };})(r));
      tb.appendChild(tr);
    }
  }

  function selectRow(sel){
    var el=$("inspector");
    if(sel.type==='trade'){
      el.innerHTML = ''+
        '<div class="flex between items-center"><div style="font-size:16px;font-weight:700">'+sel.data.ticker+' • '+sel.data.screener+'</div><div class="'+qsClass(sel.data.quality)+'">QS '+sel.data.quality+'</div></div>'+
        '<div class="mt-2">Stage: <b>'+sel.data.stage+'</b> • Side: <b>'+sel.data.side+'</b></div>'+
        '<div class="mt-2">Setup: <b>'+sel.data.setup+'</b></div>'+
        '<div class="row cols-3 mt-2" style="gap:8px">'+
          cardStat('Entry', money(sel.data.entry))+
          cardStat('Stop', money(sel.data.stop))+
          cardStat('T1', money(sel.data.t1))+
        '</div>'+
        '<div class="mt-2">Runner: <b>'+sel.data.runner+'</b> • R:R <b>'+sel.data.rr.toFixed(1)+'</b></div>'+
        (beginner? '<div class="mt-2 hint">Entry is the trigger price; Stop protects capital; T1 is where half is taken; the rest trails by EMA.</div>' : '');
    } else {
      el.innerHTML = '<div class="muted">Select a trade to view details.</div>';
    }
  }

  function cardStat(label, value){
    return '<div class="card" style="padding:8px 10px"><div class="muted" style="font-size:11px">'+label+'</div><div style="font-weight:700">'+value+'</div></div>';
  }

  // ----- Filters -----
  function applyFilters(list){
    if(activeFilters.length===0) return list;
    var out=[]; for(var i=0;i<list.length;i++){
      var r=list[i]; var ok=true;
      for(var j=0;j<activeFilters.length;j++){
        var f=activeFilters[j];
        if(f.type==='screener' && r.screener!==f.value) ok=false;
        if(f.type==='side' && r.side!==f.value) ok=false;
        if(f.type==='qs'){
          if(f.value==='80+' && !(r.quality>=80)) ok=false;
          if(f.value==='60-79' && !(r.quality>=60 && r.quality<80)) ok=false;
          if(f.value==='lt60' && !(r.quality<60)) ok=false;
        }
      }
      if(ok) out.push(r);
    }
    return out;
  }

  // ----- Simple charts with axes -----
  function drawArea(svgId, arr, colors, d){
    var svg=document.getElementById(svgId); svg.innerHTML='';
    var W=1000,H=260; var n=arr.length; if(n<2)return; var max=100,min=0; var xstep=W/(n-1);
    // grid lines
    [0,25,50,75,100].forEach(function(val){ var y=H - (val-min)/(max-min)*H; var gl=document.createElementNS('http://www.w3.org/2000/svg','line'); gl.setAttribute('x1','0'); gl.setAttribute('x2',W); gl.setAttribute('y1',y); gl.setAttribute('y2',y); gl.setAttribute('class','grid-line'); svg.appendChild(gl); var tx=document.createElementNS('http://www.w3.org/2000/svg','text'); tx.setAttribute('x','4'); tx.setAttribute('y',y-4); tx.setAttribute('class','axis-label'); tx.textContent=val; svg.appendChild(tx); });
    // path
    var pathStr=''; for(var i=0;i<n;i++){var x=i*xstep; var y=H - (arr[i]-min)/(max-min)*H; pathStr+=(i===0?'M':'L')+x.toFixed(2)+','+y.toFixed(2)+' ';}
    var fill=document.createElementNS('http://www.w3.org/2000/svg','path'); fill.setAttribute('d', pathStr+' L'+W+','+H+' L0,'+H+' Z'); fill.setAttribute('fill', colors.fill); svg.appendChild(fill);
    var line=document.createElementNS('http://www.w3.org/2000/svg','path'); line.setAttribute('d', pathStr); line.setAttribute('fill','none'); line.setAttribute('stroke', colors.stroke); line.setAttribute('stroke-width','2'); svg.appendChild(line);
    // last point marker
    var lx=(n-1)*xstep, ly=H - (arr[n-1]-min)/(max-min)*H; var circ=document.createElementNS('http://www.w3.org/2000/svg','circle'); circ.setAttribute('cx',lx); circ.setAttribute('cy',ly); circ.setAttribute('r','3.5'); circ.setAttribute('fill','#60a5fa'); svg.appendChild(circ);
    // x-axis labels
    var first=new Date(d.series[0].date).toLocaleDateString(); var mid=new Date(d.series[Math.floor(n/2)].date).toLocaleDateString(); var lastd=new Date(d.series[n-1].date).toLocaleDateString();
    [['6',H-4,first], [W/2,H-4,mid], [W-60,H-4,lastd]].forEach(function(t){ var tx=document.createElementNS('http://www.w3.org/2000/svg','text'); tx.setAttribute('x',t[0]); tx.setAttribute('y',t[1]); tx.setAttribute('class','axis-label'); tx.textContent=t[2]; svg.appendChild(tx); });
  }

  function drawLines(svgId, series, d){
    var svg=document.getElementById(svgId); svg.innerHTML='';
    var colors={vol:'#93c5fd',breadth:'#38bdf8',credit:'#34d399',trend:'#22d3ee',news:'#f59e0b'};
    var W=1000,H=240; var keys=Object.keys(series); var n=series[keys[0]].length; var xstep=W/(n-1);
    // grid
    [0,25,50,75,100].forEach(function(val){ var y=H - (val/100)*H; var gl=document.createElementNS('http://www.w3.org/2000/svg','line'); gl.setAttribute('x1','0'); gl.setAttribute('x2',W); gl.setAttribute('y1',y); gl.setAttribute('y2',y); gl.setAttribute('class','grid-line'); svg.appendChild(gl); var tx=document.createElementNS('http://www.w3.org/2000/svg','text'); tx.setAttribute('x','4'); tx.setAttribute('y',y-4); tx.setAttribute('class','axis-label'); tx.textContent=val; svg.appendChild(tx); });
    // lines
    for(var k=0;k<keys.length;k++){
      var key=keys[k], arr=series[key]; var pathStr='';
      for(var i=0;i<n;i++){var x=i*xstep; var y=H - (arr[i]/100)*H; pathStr+=(i===0?'M':'L')+x.toFixed(2)+','+y.toFixed(2)+' ';}
      var path=document.createElementNS('http://www.w3.org/2000/svg','path'); path.setAttribute('d', pathStr); path.setAttribute('fill','none'); path.setAttribute('stroke', colors[key]); path.setAttribute('stroke-width','1.8'); svg.appendChild(path);
    }
    // x-axis labels
    var first=new Date(d.series[0].date).toLocaleDateString(); var mid=new Date(d.series[Math.floor(n/2)].date).toLocaleDateString(); var lastd=new Date(d.series[n-1].date).toLocaleDateString();
    [['6',H-4,first], [W/2,H-4,mid], [W-60,H-4,lastd]].forEach(function(t){ var tx=document.createElementNS('http://www.w3.org/2000/svg','text'); tx.setAttribute('x',t[0]); tx.setAttribute('y',t[1]); tx.setAttribute('class','axis-label'); tx.textContent=t[2]; svg.appendChild(tx); });
    document.getElementById('blocks-axis').textContent = 'Timeline: '+first+' → '+lastd;
  }

  // ---- Sparkline helpers ----
  function genSpark(n, drift){ var out=[], v=50; for(var i=0;i<n;i++){ v = v + (Math.random()-0.5)*8 + (drift||0); out.push(Math.max(0,Math.min(100,v))); } return out; }
  function sparkPath(arr){ var W=120,H=26; var step=W/(arr.length-1); var p=''; for(var i=0;i<arr.length;i++){ var x=i*step; var y=H-(arr[i]/100)*H; p+=(i===0?'M':'L')+x+','+y+' '; } return '<path d="'+p+'" stroke="#7aa2ff" stroke-width="1.6" fill="none"/>'; }

  // ----- Sorting helpers -----
  function sortTable(tableId, key, asc){
    var rows = Array.prototype.slice.call(document.querySelector('#'+tableId+' tbody').children);
    rows.sort(function(a,b){
      var aa=getCellVal(a,key), bb=getCellVal(b,key);
      var na=parseFloat(aa.replace(/[$%]/g,'')), nb=parseFloat(bb.replace(/[$%]/g,''));
      if(!isNaN(na) && !isNaN(nb)) return asc? na-nb : nb-na;
      return asc? aa.localeCompare(bb) : bb.localeCompare(aa);
    });
    var tbody=document.querySelector('#'+tableId+' tbody'); tbody.innerHTML=''; for(var i=0;i<rows.length;i++) tbody.appendChild(rows[i]);
  }
  function getCellVal(tr,key){
    var headers=document.querySelectorAll('#'+tr.parentNode.parentNode.id+' thead th'); var idx=-1;
    for(var i=0;i<headers.length;i++){ if(headers[i].getAttribute('data-sort')===key){ idx=i; break; } }
    return tr.children[idx].textContent.trim();
  }

  // ----- Events -----
  function bindEvents(){
    var btns=document.querySelectorAll('.btn-tab');
    for(var i=0;i<btns.length;i++){
      btns[i].addEventListener('click', function(){
        for(var j=0;j<btns.length;j++) btns[j].classList.remove('active');
        this.classList.add('active'); mode=this.getAttribute('data-mode'); render();
      });
    }
    document.getElementById('btn-beginner').addEventListener('click', function(){ beginner=!beginner; this.textContent='Beginner Mode: '+(beginner?'ON':'OFF'); render(); });

    // Sorting
    var sorts=document.querySelectorAll('th.sortable');
    for(var k=0;k<sorts.length;k++){
      sorts[k].addEventListener('click', function(){
        var tableId=this.closest('table').id; var key=this.getAttribute('data-sort'); var asc=!this.classList.contains('asc');
        var peers=this.parentNode.children; for(var p=0;p<peers.length;p++){peers[p].classList.remove('asc'); peers[p].classList.remove('desc');}
        this.classList.add(asc?'asc':'desc');
        sortTable(tableId,key,asc);
      });
    }

    // Filters
    var tags=document.querySelectorAll('.tag');
    for(var t=0;t<tags.length;t++){
      tags[t].addEventListener('click', function(){
        var f=this.getAttribute('data-filter'); var parts=f.split(':'); var type=parts[0], value=parts[1];
        var idx=-1; for(var i=0;i<activeFilters.length;i++){ if(activeFilters[i].type===type && activeFilters[i].value===value){ idx=i; break; }}
        if(idx>=0){ activeFilters.splice(idx,1); this.classList.remove('active'); }
        else { activeFilters.push({type:type,value:value}); this.classList.add('active'); }
        renderTrades(); renderScreen();
      });
    }
    document.getElementById('btn-clear').addEventListener('click', function(){ activeFilters=[]; var tags=document.querySelectorAll('.tag'); for(var i=0;i<tags.length;i++) tags[i].classList.remove('active'); renderTrades(); renderScreen(); });
  }

  // init
  bindEvents();
  render();
})();
</script>
</body>
</html>
